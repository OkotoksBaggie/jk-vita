%% Curriculum Vitae style file
%% 
%% James Keirstead
%% Last updated: 2 March 2015
%%
%% This file contains elements from:
%%  - http://robjhyndman.com/research/cv.sty
%%  - http://kjhealy.github.com/kjh-vita
%%

\usepackage{paralist,ragged2e,datetime}
\usepackage{hyperref,fancyhdr,enumitem,color}
\usepackage[a4paper,centering]{geometry}
\usepackage[compact,small,sf,bf]{titlesec}
%\usepackage{kpfonts,dsfont}

\RaggedRight
\sloppy

% Header and footer
\pagestyle{fancy}
\lhead{\sf Curriculum Vitae: \@name}
\rhead{\sf\thepage}
\cfoot{}

% Date format
\newdateformat{rjh}{\monthname~\THEYEAR}
\rjh

% Header box
\def\name#1{\def\@name{#1}}
\def\info#1{\def\@info{#1}}
\newcommand{\shadebox}[3][.9]{\fcolorbox[gray]{0}{#1}{\parbox{#2}{#3}}}

\def\maketitle{
\thispagestyle{plain}
\vspace*{-1.4cm}
\shadebox[0.9]{17.3cm}{\sf\color[rgb]{.6,0,0}
\hbox to 17cm{\begin{tabular}{p{7.4cm}}
\LARGE\textbf{\@name}\\[0.3cm]
\Large\textbf{Curriculum Vitae}\\[0.6cm]
\normalsize\today
\end{tabular}
\hfill\hbox{\fontsize{9}{12}\sf
\begin{tabular}{@{}rp{7.2cm}@{}}
\@info
\end{tabular}}}
}
\vspace*{0.2cm}}

% A fudge from http://tex.stackexchange.com/questions/19200/titlesec-remove-space-after-empty-margin-section

\makeatletter
\newif\ifaftersec\aftersecfalse

\newcommand\setsubskip{%
    \global\aftersectrue
    \everypar{%
        \global\aftersecfalse
        \if@noskipsec
            \global\@noskipsecfalse
            \clubpenalty\@M
            \hskip-\parindent
            \begingroup
                \@svsechd\unskip{\hspace{\@tempskipb}}%
            \endgroup
        \else
            \clubpenalty\@clubpenalty\everypar{}%
        \fi}}

\newcommand\subskip{%
  \ifaftersec
     \removelastskip%         EDIT 2
     \vspace{-\baselineskip}% EDIT 2 ??????????????
  \fi
  \global\aftersecfalse}

\titleformat{\section}[leftmargin]{\raggedleft\sffamily\footnotesize}{}{0pt}{}[\setsubskip]
\titlespacing*{\section}{2cm}{2.5ex}{0.5cm}

\titleformat{\subsection}{\subskip\itshape}{}{0pt}{}[]
\titlespacing*{\subsection}{0pt}{2ex}{1ex}

\raggedbottom
\makeatother


% Section headings
%\titlelabel{}

%\titleformat{\section}[leftmargin]{\raggedleft\sffamily\footnotesize}{}{}{}
%\titlespacing*{\section}{2.5cm}{2ex}{0ex}

%%\titleformat{\section}[leftmargin]{\itshape}{}{}{}
%%\titleformat{\section}[leftmargin]{\scshape \footnotesize}{10pt}{}{}
%\titleformat{\subsection}{\itshape}{}{}{}
%\titlespacing{\subsection}{0pt}{-2ex}{0ex}

% Miscellaneous dimensions
\setlength{\parskip}{0ex}
\setlength{\parindent}{0em}
\setlength{\headheight}{15pt}
\setlength{\tabcolsep}{0.15cm}
\clubpenalty = 10000
\widowpenalty = 10000
\setlist{itemsep=1pt}
\setdescription{labelwidth=1.2cm,leftmargin=1.5cm,labelindent=1.5cm,font=\rm}

% Bibliography formatting

\usepackage[sorting=ynt,bibstyle=authoryear-comp,defernumbers=true,maxnames=20,firstinits=true, uniquename=init,dashed=false,doi=false,isbn=false,backend=biber]{biblatex}

\DeclareFieldFormat{url}{\url{#1}}
\DeclareFieldFormat[article]{pages}{#1}
\DeclareFieldFormat[inproceedings]{pages}{\lowercase{pp.}#1}
\DeclareFieldFormat[incollection]{pages}{\lowercase{pp.}#1}
\DeclareFieldFormat[article]{volume}{\mkbibbold{#1}}
\DeclareFieldFormat[article]{number}{\mkbibparens{#1}}
\DeclareFieldFormat[article]{title}{\MakeCapital{#1}}
\DeclareFieldFormat[article]{url}{}
\DeclareFieldFormat[inproceedings]{title}{#1}
\DeclareFieldFormat{shorthandwidth}{#1}
\DeclareFieldFormat{extrayear}{}

% No dot before number of articles
\usepackage{xpatch}
\xpatchbibmacro{volume+number+eid}{\setunit*{\adddot}}{}{}{}

% Remove In: for an article.
\renewbibmacro{in:}{%
  \ifentrytype{article}{}{%
  \printtext{\bibstring{in}\intitlepunct}}}

% Bibliography categories
\def\makebibcategory#1#2{\DeclareBibliographyCategory{#1}\defbibheading{#1}{\subsection*{#2}}}
\makebibcategory{books}{Books}
\makebibcategory{papers}{Journal articles}
\makebibcategory{chapters}{Book chapters}
\makebibcategory{conferences}{Conference papers \& posters}
\makebibcategory{techreports}{Unpublished working papers}
\makebibcategory{bookreviews}{Book reviews}
\makebibcategory{editorials}{Editorials}
\makebibcategory{phd}{PhD thesis}
\makebibcategory{subpapers}{Submitted papers}
\makebibcategory{curpapers}{Current projects}
\makebibcategory{other}{Reviews, software \& other writing}

\setlength{\bibitemsep}{2.5pt}
\setlength{\bibhang}{.8cm}
%\renewcommand{\bibfont}{\fontsize{12}{14}}

\renewcommand*{\bibitem}{\addtocounter{papers}{1}\item \mbox{}\hskip-0.85cm\hbox to 0.85cm{\hfill\arabic{papers}.~~}}
\defbibenvironment{bibliography}
{\list{}
  {\setlength{\leftmargin}{\bibhang}%
   \setlength{\itemsep}{\bibitemsep}%
   \setlength{\parsep}{\bibparsep}}}
{\endlist}
{\bibitem}

% \section{\LARGE Publications}
\newenvironment{publications}{\section{Publications}\label{papersstart}%\vspace*{0.2cm}%
%\titlespacing{\section}{0pt}{1.5ex}{1ex}\itemsep=0.00cm
}{\label{papersend}\addtocounter{sumpapers}{-1}\refstepcounter{sumpapers}\label{sumpapers}}

\def\printbib#1{\printbibliography[category=#1,heading=#1]\lastref{sumpapers}}
\renewcommand{\bibfont}{\normalfont\fontsize{11}{13.4}\rmfamily}
% Counters for keeping track of papers
\newcounter{papers}\setcounter{papers}{0}
\newcounter{sumpapers}\setcounter{sumpapers}{0}
\def\lastref#1{\addtocounter{#1}{\value{papers}}\setcounter{papers}{0}}

% Add all papers in the bib file.
\nocite{*}

%% used below in the hyperref declaration and address banner section.
\def\myauthor{James Keirstead}
\def\mytitle{Vita}
\def\mycopyright{\myauthor}
\def\mykeywords{}
\def\mybibliostyle{plain}
\def\mybibliocommand{}
\def\mysubtitle{}
\def\myaffiliation{Imperial College London}
\def\myaddress{Department of Civil and Environmental Engineering}
\def\myemail{j.keirstead@imperial.ac.uk}
\def\myweb{http://www.jameskeirstead.ca}
\def\myphone{+44 (0) 207 594 6010}
\def\myfax{+44 (0) 207 594 5934}
\def\myversion{}
\def\myrevision{}

\date{} % not used (revision control instead)
\def\mykeywords{James, Keirstead, James Keirstead, Vita, CV, Resume, Engineering}

%%%------------------------------------------------------------------------  
%%% Git version tracking 
%%%------------------------------------------------------------------------

%% If you don't use git or the vc package (from CTAN), comment this out.
%% If you comment it out, be sure to remove the \rfoot comment below, too.
%% See vc manual to compile with xelatex -enable-write18 vita
\immediate\write18{vc.bat}
\input{vc}

%%%------------------------------------------------------------------------
%%% Required style files
%%%------------------------------------------------------------------------
%%\usepackage{revnum} % for reverse-numbered publications (revnumerate environment) if needed.

%% needed for xelatex to work
\usepackage{fontspec}
\usepackage{xunicode}

%% color for the links 
\usepackage[usenames,dvipsnames]{xcolor}
\definecolor{ImperialBlue}{rgb}{0.082,0.416,0.608}
\definecolor{ImperialLightBlue}{rgb}{0.545,0.682,0.8}

% Bibliography stuff
\bibliography{../content/papers}
\addtocategory{books}{Keirstead2013a}
\addtocategory{papers}{Chester2014, Keirstead2014, Keirstead2014a, Keirsteada, Morlet_Keirstead_2013, Keirstead2011b, Rutter2012, Calderon2012, Keirstead2012b, Keirstead, Keirstead2011c, Keirstead2012a, Liang2012, Keirstead2010c, Liang2011, Keirstead2010b, Keirstead2009h, Keirstead2009b, Keirstead2008a, Keirstead2008, Keirstead2007b, Keirstead2007c, Keirstead2006a, Pfenninger2014a, Pfenninger2014, Pfenninger2013, Koppelaar2014}
\addtocategory{chapters}{Shah2012, Keirstead2013, Keirstead2012c, Grubler2011, Hammer2011, Schulzb, Keirstead2009f, Keirstead2010}
\addtocategory{conferences}{Giarola2013, Keirstead2011d, VanDam2011, VanDam2010, Weber2010, Keirstead2010d, Kostantinidis2010, Keirstead2010e, Keirstead2009g, Keirstead2009e, Keirstead2009c, Keirstead2009a, Keirstead2007, Keirstead2005b, Keirstead2005a, Baldock2015, Mijic2014, Sailer2015, Ravalde2014, Baedeker2014,  Pfenninger2014d, Walker2014, Pfenninger2014c, Pfenninger2014b, Keirstead2013b, Calderon2012a, Graham2012}
\addtocategory{other}{Keirstead2013c, Keirstead2013d, Keirstead2010a, Keirstead2008b, Keirstead2007a, Keirstead2005, Keirstead2010f, Keirstead2004, Keirstead2014b, Keirstead2014c, Keirstead2008c} 

%% hyperlinks
\hypersetup{xetex, 
	colorlinks=true,
	urlcolor=ImperialBlue,
	plainpages=false,
  	pdfpagelabels,
  	bookmarksnumbered,
  	pdftitle={\mytitle},
  	pagebackref,
  	pdfauthor={\myauthor},
  	pdfkeywords={\mykeywords}
  	}

%% Choose fonts for use with xelatex
%% Minion and Myriad are widely available, from Adobe. 
%% Pragmata is available to buy at http://www.fsd.it/fonts/pragma.htm
%% and is worth every penny. Any good monospace font will work fine, though.
%% Consolas or inconsolata are good alternatives.
\setromanfont[Mapping={tex-text},Numbers={OldStyle},Ligatures={Common}]{Minion Pro} 
\setsansfont[Mapping=tex-text,Colour=ImperialBlue]{Myriad Pro}
\setmonofont[Mapping=tex-text,Scale=0.9]{Avenir Next Condensed Regular} % Consolas, Pragmata, Lucida Console


%%%------------------------------------------------------------------------
%%% Local commands
%%%------------------------------------------------------------------------

%% Marginal header
%% Note: as the document goes on you may need to introduce a (gradually increasing)
%% \vspace element to keep the marginal header pleasingly aligned with the first 
%% item in the body text. Like this: \marginhead{{\vskip 0.4em}Grants}, or 
%% \marginhead{{\vskip 0.8em}Service}. Experiment as needed.
\newcommand{\marginhead}[1]{\marginpar{\textsf{{\footnotesize #1}}}}


%% custom ampersand (font consistent with the one chosen above)
\newcommand{\amper}{{\fontspec[Scale=.95,Colour=AA0000]{Minion Pro Medium}\selectfont\&\,}}

%% No bullets on labels
\renewcommand{\labelitemi}{~} 

%% Custom hanging indent for vita items
\def\ind{\hangindent=1 true cm\hangafter=1 \noindent}
%\def\ind{\hangindent=18pt\hangafter=1 \noindent}
\def\labelitemi{~}
\renewcommand{\labelitemii}{~}

%%%------------------------------------------------------------------------
%%% Page layout
%%%------------------------------------------------------------------------
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\fancyhead{}
\fancyfoot{}
\rhead{{\scriptsize\thepage}}

%% git revision control footer 
\rfoot{\textcolor{Gray}{\texttt{\scriptsize \VCRevision\ on \VCDateTEX}}} % git revision info inserted via external script -- see docs for vc package for details. comment out this line if you're not using vc, and also remove the \input{vc} line above.

\newcommand{\makeheader}{%
%%%------------------------------------------------------------------------
%%% Address and contact block
%%%------------------------------------------------------------------------
\begin{minipage}[t]{2.95in}
\flushright {\footnotesize \href{http://www.imperial.ac.uk/civilengineering}{Department of Civil \& Env.\ Engineering} \\ Imperial College London \\ London, UK\\ \vspace{-0.04in} SW7 2AZ}   
\end{minipage}
\hfill     
%\begin{minipage}[t]{0.0in}
% dummy (needed here)
%\end{minipage}
\hfill
\begin{minipage}[t]{1.7in}
  \flushright \footnotesize Phone: \myphone \\ 
  Fax: \myfax  \\ 
  {\scriptsize  \texttt{\href{mailto:\myemail}{\myemail}}} \\
  {\scriptsize  \texttt{\href{\myweb}{\myweb}}}
\end{minipage}


\bigskip

\bigskip

%% Name 
\noindent{\Large {D\textsc{r} J\textsc{ames} K\textsc{eirstead}}} {\scriptsize \textsc{CEng MEI}}
\reversemarginpar
\raggedright
}